/*! imsep 2021-01-09 */

$(function(){pageTask.init(),$.ajax({url:"/users",dataType:"json",success:function(a){if(a){var e=$.map(a,function(a){return{id:a.id,text:a.userName,data:a}});$("#usersWhoCanViewData").select2({data:e}),$("#usersWhoCanEditData").select2({data:e})}}}),$.ajax({url:"/groups",dataType:"json",success:function(a){if(a){var e=$.map(a,function(a){return{id:a.id,text:a.name,data:a}});$("#groupsWhoCanViewData").select2({data:e}),$("#groupsWhoCanEditData").select2({data:e})}}})});var pageTask={init:function(){var a=this,e=$("#details").val(),l={};try{l=JSON.parse(e)}catch(a){}this.fillUI(l),$("#cmdSave").click(function(){a.submit()})},fillUI:function(a){a.fields||(a.fields=[]);a.fields;this.details=a,this.fillDetails()},fillDetails:function(){var a=this.details,e=$("#detailsContainer"),l="";if(l+='  <div class="form-group">',l+="  </div>",a){var s=1;if(a.bands&&(s=a.bands.length),l+='<div class="row">',l+='  <label class="col-sm-3" >Raster type:</label>',l+='<div class="col-sm-4">',l+='<select class="form-control "   name="rasterType" id="rasterType" >',1==s?(l+='  <option value="SingleBand"'+("SingleBand"==a.rasterType?'selected="selected"':"")+" >Single-band </option>",l+='  <option value="SingleBand_Dem"'+("SingleBand_Dem"==a.rasterType?'selected="selected"':"")+">Single-band (DEM)</option>",l+='  <option value="SingleBand_Image"'+("SingleBand_Image"==a.rasterType?'selected="selected"':"")+">Single-band (Image)</option>"):(l+='  <option value="MultiBand"'+("MultiBand"==a.rasterType?'selected="selected"':"")+">Multi-band</option>",l+='  <option value="Image"'+("Image"==a.rasterType?'selected="selected"':"")+">Image</option>"),l+="</select> ",l+="</div>",l+="</div>",l+='<div class="row">',l+='  <label class="col-sm-3" >Image width:</label>',l+='  <label class="col-sm-3" >'+a.rasterWidth+" Pixels </label>",l+="</div>",l+='<div class="row">',l+='  <label class="col-sm-3" >Image height:</label>',l+='  <label class="col-sm-3" >'+a.rasterHeight+" Pixels </label>",l+="</div>",a.bands){l+='<div class="form-group">',1<a.bands.length?l+='  <label class="col-sm-12" for="">Bands:</label>':l+='  <label class="col-sm-12" for="">Band:</label>';for(var t=0;t<a.bands.length;t++){var i=a.bands[t];l+='<div class="row">',l+='  <label class="col-sm-offset-1 col-sm-2" >Name:</label>',l+='  <div class="col-sm-3" >',l+='  <input type="text" name="bandName_'+t+'" id="bandName_'+t+'" value="'+i.name+'"  class=" form-control" data-val="true" data-val-required="Band name is required"                               />',l+='  <span class="field-validation-valid" data-valmsg-for="bandName_'+t+'" data-valmsg-replace="true"></span>',l+="  </div>",l+="</div>",l+='<div class="row">',l+='  <label class="col-sm-offset-3 col-sm-3" >ID:</label>',l+='  <label class="col-sm-6" >'+i.id+" </label>",l+="</div>",l+='<div class="row">',l+='  <label class="col-sm-offset-3 col-sm-3" >Data type:</label>',l+='  <label class="col-sm-6" >'+i.dataType+" </label>",l+="</div>",l+='<div class="row">',l+='  <label class="col-sm-offset-3 col-sm-3" >Min value:</label>',l+='  <label class="col-sm-6" >'+i.minimum+" </label>",l+="</div>",l+='<div class="row">',l+='  <label class="col-sm-offset-3 col-sm-3" >Max value:</label>',l+='  <label class="col-sm-6" >'+i.maximum+" </label>",l+="</div>",l+='<div class="row">',l+='  <label class="col-sm-offset-3 col-sm-3" >No-data value:</label>',l+='  <label class="col-sm-6" >'+i.noDataValue+" </label>",l+="</div>",l+="<hr />"}l+="</div>"}a.spatialReference&&(l+='<div class="form-group">',l+='  <label class="col-sm-12" for="">Spatial reference:</label>',a.spatialReference.srid&&!a.spatialReference.alias&&(3857!=a.spatialReference.srid&&"3857"!=a.spatialReference.srid||(a.spatialReference.alias="Google Maps Global Mercator"),4326!=a.spatialReference.srid&&"4326"!=a.spatialReference.srid||(a.spatialReference.alias="WGS 84")),a.spatialReference.name&&(l+='<div class="row">',l+='  <label class="col-sm-offset-1 col-sm-3" >Name:</label>',a.spatialReference.alias?l+='  <label class="col-sm-8" >'+a.spatialReference.name+" ("+a.spatialReference.alias+") </label>":l+='  <label class="col-sm-8" >'+a.spatialReference.name+" </label>",l+="</div>"),a.spatialReference.srid&&(l+='<div class="row">',l+='  <label class="col-sm-offset-1 col-sm-3" >SRID:</label>',l+='  <label class="col-sm-8" >'+a.spatialReference.srid+" </label>",l+="</div>"),l+="</div>")}e.html(l)},submit:function(){var s=this;$.validator.unobtrusive.parse(document);var a=$("#mainForm");a.validate();var e=$("#frmDetail");e.validate();var l=e.valid(),t=a.valid();if(l&&t){if(waitingDialog.show("Saving Datalayer",{progressType:""}),this.details.bands)for(var i=0;i<this.details.bands.length;i++){var o=e.find("#bandName_"+i);this.details.bands[i].name=o.val()}this.details.rasterType=e.find("#rasterType").val(),a.find("#details").val(JSON.stringify(this.details)),$.ajax({type:a.attr("method"),url:a.attr("action"),data:a.serialize(),success:function(a){a.id;waitingDialog.hide();location.protocol,location.host,location.pathname;var e="/datalayer/"+a.id;if(e!=location.pathname){var l=location.protocol+"//"+location.host+e;window.history.replaceState({},document.title,l)}if(a.status){if($.notify({message:"Data Layer saved successfully"},{type:"success",delay:2e3,animate:{enter:"animated fadeInDown",exit:"animated fadeOutUp"}}),a.item&&a.item.details)try{s.fillUI(JSON.parse(a.item.details))}catch(a){}window.location.href=location.protocol+"//"+location.host+"/datalayers"}else $.notify({message:a.errors||a.error||a.message||"Failed to save Data Layer"},{type:"danger",delay:1e4,animate:{enter:"animated fadeInDown",exit:"animated fadeOutUp"}})},error:function(a,e,l){waitingDialog.hide(),console.log("An error occurred."),$.notify({message:"Failed to save Data Layer"},{type:"danger",delay:2e3,animate:{enter:"animated fadeInDown",exit:"animated fadeOutUp"}})}})}else{var n=$(".input-validation-error").first();n&&$("html, body").animate({scrollTop:n.offset().top-20},1e3)}}};