/*! imsep 2020-02-01 */

$(function(){pageTask.init(),$.ajax({url:"/users",dataType:"json",success:function(e){if(e){var i=$.map(e,function(e){return{id:e.id,text:e.userName,data:e}});$("#usersWhoCanViewData").select2({data:i}),$("#usersWhoCanEditData").select2({data:i})}}}),$.ajax({url:"/groups",dataType:"json",success:function(e){if(e){var i=$.map(e,function(e){return{id:e.id,text:e.name,data:e}});$("#groupsWhoCanViewData").select2({data:i}),$("#groupsWhoCanEditData").select2({data:i})}}})});var pageTask={init:function(){var e=this;this.fieldTypeCaptions={varchar:"Text",smallint:"Small Integer",integer:"Integer",bigint:"Big Integer",real:"Real","double precision":"Double",numeric:"Numeric",boolean:"Boolean",bytea:"BLOB",date:"Date","timestamp with time zone":"DateTime"};var i=$("#details").val(),a={};try{a=JSON.parse(i)}catch(e){}this.fillUI(a),$("#cmdSave").click(function(){e.submit()})},fillUI:function(e){e.fields||(e.fields=[]);var i=e.fields;this.details=e,this.fields=i;var a=$("#shapeType");e.shapeType&&a.val(e.shapeType),e.isNew||a.prop("disabled",!0);var t="";e.spatialReference&&(t+='  <label class="col-sm-12" for="">Spatial reference:</label>',e.spatialReference.srid&&!e.spatialReference.alias&&(3857!=e.spatialReference.srid&&"3857"!=e.spatialReference.srid||(e.spatialReference.alias="Google Maps Global Mercator"),4326!=e.spatialReference.srid&&"4326"!=e.spatialReference.srid||(e.spatialReference.alias="WGS 84")),e.spatialReference.name&&(t+='<div class="row">',t+='  <label class="col-sm-offset-1 col-sm-3" >Name:</label>',e.spatialReference.alias?t+='  <label class="col-sm-8" >'+e.spatialReference.name+" ("+e.spatialReference.alias+") </label>":t+='  <label class="col-sm-8" >'+e.spatialReference.name+" </label>",t+="</div>"),e.spatialReference.srid&&(t+='<div class="row">',t+='  <label class="col-sm-offset-1 col-sm-3" >SRID:</label>',t+='  <label class="col-sm-8" >'+e.spatialReference.srid+" </label>",t+="</div>")),$("#spatialreferenceInfo").html(t),this.fillFieldList()},fillFieldList:function(){this.details;var e=this.fields,i=$("#fieldsContainer"),a='<div class="table-responsive col-sm-12">';a+=' <table class="table table-condensed"><thead><tr>',a+=" <th>Name</th>",a+=' <th class="hidden-xs hidden-sm">Alias</th>',a+=' <th class="hidden-xs hidden-sm">Type</th>',a+=' <th class="hidden-xs ">Length</th>',a+=' <th class="hidden-xs ">Default value</th>',a+=' <th> <button type="button" class="btn btn-xs btn-primary\t" onclick="javascript:pageTask.editField(-1);"><span class="glyphicon glyphicon-plus"></span> Add</button></th>',a+=" <th></th>",a+=" </tr></thead>",a+=' <tbody id="tblItems">';for(var t=0;t<e.length;t++){var n=e[t];n._action||(n._action={});var s="";n._action.isNew?s="info":n._action.delete?s="danger":n._action.modified&&(s="warning");var l=this.fieldTypeCaptions[n.type.toLowerCase()];a+=' <tr class="'+s+'" >',a+=" <td>"+n.name+"</td>",a+=' <td class="hidden-xs hidden-sm" >'+(n.alias?n.alias:"")+"</td>",a+=' <td class="hidden-xs hidden-sm">'+l+"</td>",a+=' <td class="hidden-xs ">'+(void 0!==n.length?n.length:"")+"</td>",a+=' <td class="hidden-xs ">'+(void 0!==n.default?n.default:"")+"</td>",n._action.delete?a+=' <td> <button type="button" class="btn btn-xs btn-info disabled\t" disabled onclick="javascript:"><span class="glyphicon glyphicon-edit"></span> Edit</button></td>':a+=' <td> <button type="button" class="btn btn-xs btn-info\t" onclick="javascript:pageTask.editField('+t+');"><span class="glyphicon glyphicon-edit"></span> Edit</button></td>',n._action.delete?a+=' <td><button type="button" class="btn btn-xs btn-danger\t" title="Undelete" style=" text-decoration: line-through;" class="btn-link  glyphicon glyphicon-remove" onclick="javascript:pageTask.deleteField('+t+');"><span class="glyphicon glyphicon-remove"></span> Undelete</button></td>':a+=' <td><button type="button" class="btn btn-xs btn-danger\t"  title="Delete"  style="" class="btn-link  glyphicon glyphicon-remove" onclick="javascript:pageTask.deleteField('+t+');"><span class="glyphicon glyphicon-remove"></span> Delete</button></td>',a+=" </tr>"}0<e.length&&(a+=" <tr>",a+=" <td></td>",a+=' <td class="hidden-xs hidden-sm"></td>',a+=' <td class="hidden-xs hidden-sm"></td>',a+=' <td class="hidden-xs "></td>',a+=' <td class="hidden-xs "></td>',a+=' <td> <button type="button" class="btn btn-xs btn-primary\t" onclick="javascript:pageTask.editField(-1);"><span class="glyphicon glyphicon-plus"></span> Add</button></td>',a+=" <td></td>",a+=" </tr>"),a+=" </tbody>",a+=" </table>",a+=" </div>",i.html(a)},deleteField:function(e){var i=this.fields,a=i[e];a._action||(a._action={}),a._action.isNew?0<=e&&e<i.length&&i.splice(e,1):a._action.delete?delete a._action.delete:a._action.delete=!0,this.fillFieldList()},editField:function(t){var i,a=this,n=this.fields,s=!1;if(t<0?i={_action:{isNew:s=!0}}:t<n.length&&(i=n[t]),i){i._action||(i._action={}),i._action.isNew||i._action.origField||(i._action.origField={name:i.name,alias:i.alias,description:i.description,type:i.type,length:i.length,default:i.default,notNull:i.notNull,isExpression:i.isExpression,expression:i.expression}),i._action.index=t;var e=$("#shapeType").val();new EditFieldDlg({field:i,shapeType:e,details:a.details,onValidate:function(e){for(var i=!1,a=0;a<n.length;a++)if(t!=a&&e.field.name.toLowerCase()==(n[a].name+"").toLowerCase()){i=!0;break}if(i)return e.valid=!1,void(e.message=e.field.name+" already exists!")},onSuccess:function(e){i._action.modified=!0,i.name=e.field.name,i.alias=e.field.alias,i.description=e.field.description,i.type=e.field.type,i.length=e.field.length,i.scale=e.field.scale,i.default=e.field.default,i.notNull=e.field.notNull,i.isExpression=e.field.isExpression,i.expression=e.field.expression,i.domain=e.field.domain,i._action.origField&&i.name===i._action.origField.name&&i.alias==i._action.origField.alias&&i.type===i._action.origField.type&&i.length==i._action.origField.length&&i.scale==i._action.origField.scale&&i.default==i._action.origField.default&&i.notNull==i._action.origField.notNull&&i.expression==i._action.origField.expression&&(i._action.modified=!1),s&&(i.expression&&(i.isExpression=!0),n.push(i)),a.fillFieldList()}}).show()}},submit:function(){var l=this;$.validator.unobtrusive.parse(document);var e=$("#mainForm");e.validate();var i=$("#frmDetail");i.validate();var a=i.valid(),t=e.valid();if(a&&t){waitingDialog.show("Saving Datalayer",{progressType:""});var o=this.details.datasetName;this.details.isNew&&(this.details.shapeType=$("#shapeType").val()),o||(o=""),e.find("#details").val(JSON.stringify(this.details)),$.ajax({type:e.attr("method"),url:e.attr("action"),data:e.serialize(),success:function(e){e.id;waitingDialog.hide();location.protocol,location.host,location.pathname;var i="/datalayer/"+e.id;if(i!=location.pathname){var a=location.protocol+"//"+location.host+i;window.history.replaceState({},document.title,a)}if(e.status){if($.notify({message:"Data Layer saved successfully"},{type:"success",delay:2e3,animate:{enter:"animated fadeInDown",exit:"animated fadeOutUp"}}),e.item&&e.item.details)try{l.fillUI(JSON.parse(e.item.details))}catch(e){}var t="/datalayer/"+e.id+"/geojson"+"?settings="+encodeURIComponent(JSON.stringify({filter:{},validate:!0})),n=$.notify({message:'<i class="wait-icon-with-padding">Validating ...</i><br />'},{type:"info",delay:0,z_index:5e4,animate:{enter:"animated fadeInDown",exit:"animated fadeOutUp"}});$.ajax(t,{type:"GET",dataType:"json",success:function(e){e&&(e.status?($.notify({message:e.rowCount+" row(s) are returned successfully."},{type:"success",delay:3e3,z_index:5e4,animate:{enter:"animated fadeInDown",exit:"animated fadeOutUp"}}),setTimeout(function(){window.location.href=location.protocol+"//"+location.host+"/datalayers"},2e3)):$.notify({message:"Validation failed <br />Error:"+e.message+"<br/> Check fields' expressions"},{type:"danger",delay:5e3,z_index:5e4,animate:{enter:"animated fadeInDown",exit:"animated fadeOutUp"}})),n.close()},error:function(e,i,a){$.notify({message:a+"<br/>Failed to complete task"},{type:"danger",delay:3e3,z_index:5e4,animate:{enter:"animated fadeInDown",exit:"animated fadeOutUp"}}),n.close()}}).done(function(e){n.close()})}else{var s=e.errors||e.error||e.message||"Failed to save Data Layer";s=(s+="").replace(new RegExp(o,"g"),""),$.notify({message:s},{type:"danger",delay:1e4,animate:{enter:"animated fadeInDown",exit:"animated fadeOutUp"}})}},error:function(e,i,a){waitingDialog.hide(),console.log("An error occurred."),$.notify({message:"Failed to save Data Layer"},{type:"danger",delay:2e3,animate:{enter:"animated fadeInDown",exit:"animated fadeOutUp"}})}})}else{var n=$(".input-validation-error").first();n&&$("html, body").animate({scrollTop:n.offset().top-20},1e3)}}};function EditFieldDlg(e){var a=this;this.fieldTypeTips={varchar:"variable-length character string, up to defined Length",boolean:"Boolean values like;true|false,yes|no,1|0",smallint:"2 bytes small integer, range:\t-32768 to +32767",integer:"4 bytes typical choice for integer, range: -2147483648 to +2147483647",bigint:"8 bytes large integer, rage: -9223372036854775808 to +9223372036854775807",numeric:"variable\tnumber with user-specified precision. <br /> Example, A numeric field with Length=5 and Scale=2 can store -999.99 to 999.99 ",real:"4 bytes\tvariable-precision, inexact\t6 decimal digits precision","double precision":"8 bytes\tvariable-precision, inexact\t15 decimal digits precision",date:"4 bytes date (no time of day)","timestamp with time zone":'8 bytes\tboth date and time with time zone, example:2018-08-28 12:22:01.673<span class="label label-info">+04:30</span>',bytea:"BLOB, Binary Large OBject"},this.options=e||{},this.field=this.options.field,this.parent_shapeType=this.options.shapeType,this.parent_details=this.options.details||{},void 0===this.field.type&&(this.field.type="varchar",this.field.length=20),this.onSuccess=this.options.onSuccess,this.onValidate=this.options.onValidate,this.body=$("#fieldDlgTemplate").clone(),this.dlg=new BootstrapDialog({title:"Field properties",message:function(e){var i=a.body;a.initFrom();i.find("#type").change(function(){a.updateUI()});return a.updateUI(),i},draggable:!0,closable:!0,closeByBackdrop:!0,closeByKeyboard:!0,buttons:[{label:"OK",cssClass:"btn-primary",action:function(e){a.apply()&&(a.changesApplied=!0,e.close())}},{label:"Cancel",action:function(e){e.close()}}],onshow:function(e){},onshown:function(e){},onhide:function(e){},onhidden:function(e){a.changesApplied||a.cancelSettings()}})}EditFieldDlg.prototype.initFrom=function(){var e=this,n=this.body;if(e.field){n.find("#name").val(void 0===e.field.name?"":e.field.name),n.find("#alias").val(void 0===e.field.alias?"":e.field.alias),n.find("#description").val(void 0===e.field.description?"":e.field.description);var i=n.find("#type");i.val(void 0===e.field.type?"varchar":e.field.type);var a,t=i.val();n.find("#typeTip").html(e.fieldTypeTips[t]),n.find("#length").val(void 0===e.field.length?"":e.field.length),n.find("#scale").val(void 0===e.field.scale?"":e.field.scale),n.find("#default").val(e.field.default),e.parent_details&&e.parent_details.spatialReference&&(a=e.parent_details.spatialReference.srid);var s="";"MultiPolygon"!=e.parent_shapeType&&"Polygon"!=e.parent_shapeType||(4326==a?(s+='<option value="ST_Area(geom::geography)" > Area</option>',s+='<option value="ST_Perimeter(geom::geography)" > Perimeter</option>'):(s+='<option value="ST_Area(geom)" > Area</option>',s+='<option value="ST_Perimeter(geom)" > Perimeter</option>'),s+='<option value="ST_X(ST_Centroid(geom))" > Centroid.X</option>',s+='<option value="ST_Y(ST_Centroid(geom))" > Centroid.Y</option>'),"MultiLineString"!=e.parent_shapeType&&"LineString"!=e.parent_shapeType||(s+=4326==a?'<option value="ST_Length(geom::geography)" > Length</option>':'<option value="ST_Length(geom)" > Length</option>',s+='<option value="ST_X(ST_Centroid(geom))" > Centroid.X</option>',s+='<option value="ST_Y(ST_Centroid(geom))" > Centroid.Y</option>'),"Point"==e.parent_shapeType&&(s+='<option value="ST_X(geom)" > X</option>',s+='<option value="ST_Y(geom)" > Y</option>'),n.find("#expression").append(s),n.find("#expression").val(e.field.expression),n.find("#expression").change(function(){n.find("#type").val("real")}),n.find("#domain").change(function(){var e=$(this).val();n.find(".domainTypePanel").hide(),n.find("#domainTypePanel_"+e).removeClass("hidden"),n.find("#domainTypePanel_"+e).show()});var l=0;if(n.find("#addCodedValue").on("click",function(){d("","")}),n.find("#tblCodedValues").on("click",".ibtnDel",function(e){$(this).closest("tr").remove(),l-=1}),e.field.domain&&"codedValues"==e.field.domain.type)for(var o=0;e.field.domain.items&&o<e.field.domain.items.length;o++)d(e.field.domain.items[o].code,e.field.domain.items[o].value);e.field.domain&&"range"==e.field.domain.type&&(n.find("#minValue").val(e.field.domain.minValue),n.find("#maxValue").val(e.field.domain.maxValue)),e.field.domain&&e.field.domain.type&&(n.find("#domain").val(e.field.domain.type),n.find("#domain").trigger("change"))}function d(e,i){var a=$("<tr>"),t="";t+='<td><input type="text" class="form-control codedValues_domainCode  nospinner" value="'+e+'"  name="domainCode'+l+'"  data-val="true" data-val-required="Code value is required"/><span class="field-validation-valid" data-valmsg-for="domainCode'+l+'" data-valmsg-replace="true"></span></td>',t+='<td><input type="text" class="form-control codedValues_domainValue nospinner" value="'+i+'"  name="domainValue'+l+'" ></td>',t+=' <td><button type="button" class="ibtnDel btn btn-xs btn-danger\t"  title="Delete"  style="" ><span class="glyphicon glyphicon-remove"></span> </button></td>',a.append(t),n.find("#tblCodedValues").append(a),l++}},EditFieldDlg.prototype.updateUI=function(){var e=this.body,i=e.find("#type").val();e.find("#typeTip").html(this.fieldTypeTips[i]);var a=!1;this.field&&this.field._action&&this.field._action.isNew&&(a=!0);var t=!1;"smallint"!=i&&"integer"!=i&&"bigint"!=i&&"numeric"!=i&&"real"!=i&&"double precision"!=i||(t=!0),"smallint"!=i&&"integer"!=i&&"bigint"!=i||(t=!0),"varchar"==i||"numeric"==i?e.find(".form-group").has("#length").show():e.find(".form-group").has("#length").hide(),"numeric"==i?e.find(".form-group").has("#scale").show():e.find(".form-group").has("#scale").hide(),this.field&&this.field.isExpression?(e.find(".form-group").has("#expression").show(),e.find(".form-group").has("#default").hide(),e.find(".form-group").has("#type").hide(),e.find(".form-group").has("#typeTip").hide(),e.find(".form-group").has("#length").hide()):(a&&t?e.find(".form-group").has("#expression").show():e.find(".form-group").has("#expression").hide(),e.find(".form-group").has("#default").show(),e.find(".form-group").has("#type").show(),e.find(".form-group").has("#typeTip").show()),t?(e.find(".form-group").has("#domain").show(),e.find("#domain").trigger("change")):(e.find(".form-group").has("#domain").hide(),e.find("#domainTypePanel_codedValues").hide(),e.find("#domainTypePanel_range").hide())},EditFieldDlg.prototype.create=function(){this.changesApplied=!1},EditFieldDlg.prototype.apply=function(){$.validator.unobtrusive.parse(document),this.body.find("#errors").hide();var e=this.body.find("#frmField");if(e.validate(),!e.valid())return!1;var i=e.find("#type").val(),a=e.find("#scale").val();try{a=parseInt(a),isNaN(a)&&(a=void 0)}catch(e){}var t=e.find("#length").val();try{t=parseInt(t),isNaN(t)&&(t=void 0)}catch(e){}var n={name:e.find("#name").val(),type:i,notNull:this.field.notNull,isExpression:this.field.isExpression};e.find("#alias").val()&&(n.alias=e.find("#alias").val()),e.find("#description").val()&&(n.description=e.find("#description").val()),t&&(n.length=t),a&&(n.scale=a),e.find("#default").val()&&(n.default=e.find("#default").val()),"varchar"!=i&&"numeric"!=i&&(n.length=""),n.expression=e.find("#expression").val();var s=e.find("#domain").val();if("range"===s&&(n.domain={type:"range",minValue:e.find("#minValue").val(),maxValue:e.find("#maxValue").val()}),"codedValues"===s&&(n.domain={type:"codedValues",items:[]},e.find("#tblCodedValues > tbody > tr").each(function(){var e=$(this).find(".codedValues_domainCode").val(),i=$(this).find(".codedValues_domainValue").val();n.domain.items.push({code:e,value:i})})),this.onValidate){var l={valid:!0,message:"",field:n};if(this.onValidate(l),!l.valid)return this.body.find("#errors").html("<div>"+l.message+"</div>").show(),!1}return this.onSuccess&&this.onSuccess({field:n}),!0},EditFieldDlg.prototype.cancelSettings=function(){return!0},EditFieldDlg.prototype.show=function(){this.create(),this.dlg.open()};