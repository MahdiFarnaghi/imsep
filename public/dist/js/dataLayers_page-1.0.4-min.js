/*! imsep 2020-03-08 */

$(function(){pageTask.init()});var pageTask={init:function(){var i=this;this.filterExpression="",this.applyMapExtent=!1,this.mapExtent={minx:-180,miny:-90,maxx:180,maxy:90};var t=$("#items").val();this.items=[],this.data={},this.pagination={};try{this.data=JSON.parse(t),this.items=this.data.items,this.pagination=this.data.pagination}catch(t){}$("#tblItems_search").on("keyup",function(t){if(13==t.which){var a=$(this).val().toLowerCase();i.filterExpression=a,i.applyFilters()}}),$("#text_search_btn").on("click",function(){var t=$("#tblItems_search").val().toLowerCase();i.filterExpression=t,i.applyFilters()}),$("#applyMapExtent").prop("checked",!!i.applyMapExtent),$("#applyMapExtent").change(function(){i.applyMapExtent=$(this).prop("checked"),i.applyFilters()}),$("#pnlExtentMap").addClass("collapse"),$("#pnlExtentMapCmd").addClass("collapsed"),this.fillUI();var a=i.getFiltersUrl();i.last_url=a,history.pushState({url:a},document.title,a),window.addEventListener("popstate",function(t){t.state&&t.state.url&&i.getFromUrl(t.state.url,!0)})},showWaiting:function(){$("#tblItems").html('<div class="col-xs-18 col-sm-12 col-md-12 "> <div class="thumbnail waitbar_h" style="height:30px"  ></div> </div>')},deleteItem:function(a){var i=this,e=$('#tblItems .item-container[data-id="'+a+'"]');e.addClass("selected");(new ConfirmDialog).show("Are you sure you want to delete selected data layer?",function(t){e.removeClass("selected"),t&&i.deleteItemForReal(a)},{dialogSize:"m",alertType:"danger"})},deleteItemForReal:function(t){var a=this,i="/datalayer/"+t+"/delete?_method=DELETE";$.ajax(i,{type:"POST"}).done(function(t){a.last_url&&a.getFromUrl(a.last_url)})},fillItems:function(t){var a=this,i=$("#tblItems"),e="";e+=this.get_pagination(this.pagination);for(var s=0;s<t.length;s++){var l=t[s];if(e+='<div class="col-xs-18 col-sm-12 col-md-12 listItem"',e+='              data-subtype="'+l.subtype+'"',e+='              data-datatype="'+l.fileType+'"',e+='              data-keywords="'+l.keywords+'"',e+='              data-ext_north="'+l.ext_north+'"',e+='              data-ext_east="'+l.ext_east+'"',e+='              data-ext_west="'+l.ext_west+'"',e+='              data-ext_south="'+l.ext_south+'"',e+=">",e+=' <div class="item-container" data-id="'+l.id+'" >',e+='   <div class="thumbnail">',e+='     <div class="caption">',e+='       <a href="/map/preview?layers='+l.id+'" >',l.thumbnail?e+='       <img class="avatar" src="'+l.thumbnail+'" />':e+='       <i class="avatar fa fa-map-o"> </i>',e+="         <h4>","MultiPolygon"==l.subType&&(e+='         <i class="layerSubtype">▭</i>'),"MultiLineString"==l.subType&&(e+='         <i class="layerSubtype">▬</i>'),"Point"==l.subType&&(e+='       <i class="layerSubtype">◈</i>'),"raster"==l.dataType&&(e+='       <i class="layerSubtype">▦</i>'),e+="       "+l.name,e+="         </h4>",e+="       </a>",e+='     <p class="item-description" >'+(l.description||"").replace(/(?:\r\n|\r|\n)/g,"<br />")+"</p>",e+='     <ul class="list-inline">',l.updatedAt){var r=l.updatedAt+"",n=new Date(r),o=n.toString();o=n.toLocaleString(),e+="       <li>",e+='         <i class="fa fa-calendar fa-calendar-o"></i><span class="convertTolocalDateTime__" title="Definition modified at '+(" ("+n.toLocaleString("en",{timeZone:"UTC"})+" GMT)")+'" >'+o+"</span>",e+="       </li>"}e+="       <li>",e+='           <i class="fa fa-user" title="Owner" ></i>',app.identity.id==l.OwnerUser.id?e+='           <b> <span title="Owner" >'+l.OwnerUser.userName+"</span></b>":e+='           <span title="Owner">'+l.OwnerUser.userName+"</span>",e+="       </li>",(app.identity.isAdministrator||app.identity.id==l.OwnerUser.id||(app.identity.isPowerUser||app.identity.isDataManager||app.identity.isDataAnalyst)&&l._userHasPermission_EditSchema)&&(e+="       <li>",e+='          <a href="/datalayer/'+l.id+"?dataType="+l.dataType+'"><i class="glyphicon glyphicon-edit"></i></a>',e+="       </li>"),e+="       <li>",(app.identity.isAdministrator||app.identity.id==l.OwnerUser.id||l.OwnerUser.parent==app.identity.id)&&(e+='         <button title="Delete" type="button" style="color:red" class="delete-item btn-link  glyphicon glyphicon-remove" data-id="'+l.id+'" > </button>'),e+="       </li>",e+="      </ul>",e+="     </div>",e+="   </div>",e+=" </div>",e+="</div>"}i.html(e),i.find(".page-link").click(function(){if(!$(this).parent().hasClass("disabled")){var t=$(this).data("url");t&&a.getFromUrl(t)}}),i.find(".delete-item").click(function(){var t=$(this).data("id");t&&a.deleteItem(t)})},fillUI:function(){if(this.fillingUI=!0,this.fillStatistics(this.data.statistics,this.data.pagination),$("#tblItems_search").val(this.pagination.filterExpression),this.pagination.extent){var t=this.pagination.extent.split(",");this.mapExtent={minx:t[0],miny:t[1],maxx:t[2],maxy:t[3]},this.applyMapExtent=!0}this.fillItems(this.items),this.fillOrderByList(this.data.pagination),this.fillingUI=!1},get_pagination:function(t){var a=this,i="";if(!t)return i;if(!t.limit)return i;if(!t.totalItems)return'<div class="panel-heading"><legend>No item found</legend></div>';t.start||(t.start=1);var e=Math.ceil(t.totalItems/t.limit),s=Math.floor((t.start-1)/t.limit)+1;e<s&&(s=e);var l=t.limit,r=e,n=s-1,o=s+1;n<1&&(n=1),r<o&&(o=r);return i+='<div class="col-xs-18 col-sm-12 col-md-12"> <ul style="margin-top: 0;margin-bottom: 0;" class="pagination  pagination-sm">',i+='   <li class="page-item first-item '+(1==s?"disabled":"")+'">',i+='     <span class="page-link" href="#" data-url="'+a.getFiltersUrl({start:0*l+1})+'"><<</span>',i+="   </li>",i+='   <li class="page-item previous-item '+(n==s?"disabled":"")+'">',i+='     <span  class="page-link" href="#" data-url="'+a.getFiltersUrl({start:(n-1)*l+1})+'"><</span>',i+="   </li>",i+='   <li class="page-item next-item ">',i+='     <span  class="page-link" href="#" data-url=""'+a.getFiltersUrl({start:(s-1)*l+1})+'">Page '+s+"/"+e+" of "+t.totalItems+" itmes </span>",i+="   </li>",i+='   <li class="page-item next-item '+(o==s?"disabled":"")+'">',i+='     <span  class="page-link" href="#" data-url="'+a.getFiltersUrl({start:(o-1)*l+1})+'">></span>',i+="   </li>",i+='   <li class="page-item last-item '+(r==s?"disabled":"")+'">',i+='     <span  class="page-link" href="#" data-url="'+a.getFiltersUrl({start:(r-1)*l+1})+'">>></span>',i+="   </li>",i+="</ul></div>"},fillStatistics:function(t,a){this.fillStatistics_authors(t,a),this.fillStatistics_datasettypes(t,a),this.fillStatistics_keywords(t,a)},fillStatistics_authors:function(t,a){var i=this,e="";if(t&&t.authors){for(var s=t.authors,l=0;l<s.length;l++){var r=s[l];e+="<li>",e+='     <span  class="list-group-item" data-filtertype="author" data-filter="'+r.name+'" >'+r.name+'<span class="badge pull-right">'+r.total+"</span></span>",e+="</li>"}if($("#authors").html(e),$("#authors .list-group-item").click(function(){$(this).toggleClass("active"),i.applyFilters()}),a&&a.authors)for(l=0;l<a.authors.length;l++){$("#authors .list-group-item[data-filter='"+a.authors[l]+"']");$('#authors .list-group-item[data-filter="'+a.authors[l]+'"]').addClass("active")}}},fillStatistics_datasettypes:function(t,a){var i=this,e="";if(t&&t.datasetTypes){for(var s=t.datasetTypes,l=0;l<s.length;l++){var r=s[l];e+="<li>",e+='     <span  class="list-group-item" data-filtertype="datasetType" data-filter="'+r.name+'" >'+r.name+'<span class="badge pull-right">'+r.total+"</span></span>",e+="</li>"}if($("#datasetTypes").html(e),$("#datasetTypes .list-group-item").click(function(){$(this).toggleClass("active"),i.applyFilters()}),a&&a.datasetTypes)for(l=0;l<a.datasetTypes.length;l++)$('#datasetTypes .list-group-item[data-filter="'+a.datasetTypes[l]+'"]').addClass("active")}},fillStatistics_keywords:function(t,a){var i=this,e="";if(t&&t.keywords){for(var s=t.keywords,l=0;l<s.length;l++){var r=s[l];e+="<li>",e+='     <span  class="list-group-item" data-filtertype="keyword" data-filter="'+r.name+'" >'+r.name+'<span class="badge pull-right">'+r.total+"</span></span>",e+="</li>"}if($("#keywords").html(e),$("#keywords .list-group-item").click(function(){$(this).toggleClass("active"),i.applyFilters()}),a&&a.keywords)for(l=0;l<a.keywords.length;l++)$('#keywords .list-group-item[data-filter="'+a.keywords[l]+'"]').addClass("active")}},fillOrderByList:function(t){var i=this;if("<li>",'     <span  class="list-group-item glyphicon glyphicon-sort-by-attributes" data-filtertype="orderby" data-filter="name" > Name</span>','     <span  class="list-group-item glyphicon glyphicon-sort-by-attributes" data-filtertype="orderby" data-filter="updatedAt" > Date</span>',"</li>",$("#orderbys").html('<li>     <span  class="list-group-item glyphicon glyphicon-sort-by-attributes" data-filtertype="orderby" data-filter="name" > Name</span>     <span  class="list-group-item glyphicon glyphicon-sort-by-attributes" data-filtertype="orderby" data-filter="updatedAt" > Date</span></li>'),$("#orderbys .list-group-item").click(function(){var t=$(this).hasClass("active");$("#orderbys .list-group-item").removeClass("active"),$(this).addClass("active");var a=$(this).data("filter");a&&t&&(0==a.indexOf("-")?(a=a.substring(1),$(this).removeClass("glyphicon-sort-by-attributes-alt"),$(this).addClass("glyphicon-sort-by-attributes")):(a="-"+a,$(this).removeClass("glyphicon-sort-by-attributes"),$(this).addClass("glyphicon-sort-by-attributes-alt")),$(this).data("filter",a)),i.applyFilters()}),t&&t.orderby){var a=t.orderby,e=a,s=!1;0==a.indexOf("-")&&(e=a.substring(1),s=!0);var l=$('#orderbys .list-group-item[data-filter="'+e+'"]');l.addClass("active"),s&&(l.removeClass("glyphicon-sort-by-attributes"),l.addClass("glyphicon-sort-by-attributes-alt")),l.data("filter",a)}},createExtMap:function(){var s=this;(this.map=new ol.Map({target:"extMap",layers:[new ol.layer.Tile({title:"OSM",source:new ol.source.OSM})],view:new ol.View({center:ol.proj.fromLonLat([app.initMap_Lon||0,app.initMap_Lat||0]),zoom:app.initMap_Zoom||4})})).on("moveend",function(t){var a=t.map,i=a.getView().getProjection().getCode(),e=a.getView().calculateExtent(a.getSize());e=ol.extent.applyTransform(e,ol.proj.getTransform(i,"EPSG:4326")),s.mapExtent={minx:e[0],miny:e[1],maxx:e[2],maxy:e[3]},s.applyMapExtent&&s.applyFilters()})},applyFilters_local:function(){var t=this,a=t.mapExtent,i=t.filterExpression;$("#tblItems .listItem").filter(function(){t.checkFilterExpression(this,i)&&t.checkFilterExtent(this,a)?$(this).toggle(!0):$(this).toggle(!1)})},checkFilterExpression:function(t,a){return!t||(!a||(a=(a+"").toLowerCase(),-1<$(t).text().toLowerCase().indexOf(a)))},checkFilterExtent:function(t,a){if(!this.applyMapExtent)return!0;if(!t)return!0;if(!a)return!0;var i=$(t).data("ext_west"),e=$(t).data("ext_east"),s=$(t).data("ext_south"),l=$(t).data("ext_north");try{return i=parseFloat(i),s=parseFloat(s),e=parseFloat(e),l=parseFloat(l),!(i>a.maxx||e<a.minx||s>a.maxy||l<a.miny)}catch(t){return!0}},applyFilters:function(){if(!this.fillingUI){var t=this.getFiltersUrl();this.getFromUrl(t)}},getFiltersUrl:function(t){t=t||{};var a,i=this.mapExtent,e=this.filterExpression;t.filterExpression&&(e=t.filterExpression),this.applyMapExtent&&i&&(a=i.minx+","+i.miny+","+i.maxx+","+i.maxy),t.extent&&(a=t.extent);var s,l=[],r=1;return t.start?r=t.start:this.pagination&&(r=this.pagination.start),l.push("start="+r),t.limit?s=t.limit:this.pagination&&(s=this.pagination.limit),l.push("limit="+s),a&&l.push("extent="+a),e&&l.push("filterExpression="+encodeURIComponent(e)),$(".list-group-item.active").each(function(){var t=$(this).data("filtertype");if(t){var a=$(this).data("filter");l.push(t+"="+encodeURIComponent(a))}}),"?"+l.join("&")},getFromUrl:function(a,i){var e=this;e.last_url=a,e.showWaiting(),$.ajax({url:"/datalayers"+a+"&format=json",dataType:"json",success:function(t){i||history.pushState({url:a},document.title,a),t&&(e.data=t,e.items=t.items,e.pagination=t.pagination,e.fillUI())},error:function(t,a,i){var e=i||a||"Failed";t&&t.responseJSON&&t.responseJSON.error&&(e=t.responseJSON.error),$.notify({message:e},{type:"danger",delay:2e3,animate:{enter:"animated fadeInDown",exit:"animated fadeOutUp"}})}})}};