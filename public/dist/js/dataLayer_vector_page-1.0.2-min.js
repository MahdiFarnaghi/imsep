/*! imsep 2019-05-02 */

$(function(){pageTask.init(),$.ajax({url:"/users",dataType:"json",success:function(e){if(e){var i=$.map(e,function(e){return{id:e.id,text:e.userName,data:e}});$("#usersWhoCanViewData").select2({data:i}),$("#usersWhoCanEditData").select2({data:i})}}}),$.ajax({url:"/groups",dataType:"json",success:function(e){if(e){var i=$.map(e,function(e){return{id:e.id,text:e.name,data:e}});$("#groupsWhoCanViewData").select2({data:i}),$("#groupsWhoCanEditData").select2({data:i})}}})});var pageTask={init:function(){var e=this;this.fieldTypeCaptions={varchar:"Text",smallint:"Small Integer",integer:"Integer",bigint:"Big Integer",real:"Real","double precision":"Double",numeric:"Numeric",boolean:"Boolean",bytea:"BLOB",date:"Date","timestamp with time zone":"DateTime"};var i=$("#details").val(),t={};try{t=JSON.parse(i)}catch(e){}this.fillUI(t),$("#cmdSave").click(function(){e.submit()})},fillUI:function(e){e.fields||(e.fields=[]);var i=e.fields;this.details=e,this.fields=i;var t=$("#shapeType");e.shapeType&&t.val(e.shapeType),e.isNew||t.prop("disabled",!0);var a="";e.spatialReference&&(a+='  <label class="col-sm-12" for="">Spatial reference:</label>',e.spatialReference.srid&&!e.spatialReference.alias&&(3857!=e.spatialReference.srid&&"3857"!=e.spatialReference.srid||(e.spatialReference.alias="Google Maps Global Mercator"),4326!=e.spatialReference.srid&&"4326"!=e.spatialReference.srid||(e.spatialReference.alias="WGS 84")),e.spatialReference.name&&(a+='<div class="row">',a+='  <label class="col-sm-offset-1 col-sm-3" >Name:</label>',e.spatialReference.alias?a+='  <label class="col-sm-8" >'+e.spatialReference.name+" ("+e.spatialReference.alias+") </label>":a+='  <label class="col-sm-8" >'+e.spatialReference.name+" </label>",a+="</div>"),e.spatialReference.srid&&(a+='<div class="row">',a+='  <label class="col-sm-offset-1 col-sm-3" >SRID:</label>',a+='  <label class="col-sm-8" >'+e.spatialReference.srid+" </label>",a+="</div>")),$("#spatialreferenceInfo").html(a),this.fillFieldList()},fillFieldList:function(){this.details;var e=this.fields,i=$("#fieldsContainer"),t='<div class="table-responsive col-sm-12">';t+=' <table class="table table-condensed"><thead><tr>',t+=" <th>Name</th>",t+=' <th class="hidden-xs hidden-sm">Alias</th>',t+=' <th class="hidden-xs hidden-sm">Type</th>',t+=' <th class="hidden-xs ">Length</th>',t+=' <th class="hidden-xs ">Default value</th>',t+=' <th> <button type="button" class="btn btn-xs btn-primary\t" onclick="javascript:pageTask.editField(-1);"><span class="glyphicon glyphicon-plus"></span> Add</button></th>',t+=" <th></th>",t+=" </tr></thead>",t+=' <tbody id="tblItems">';for(var a=0;a<e.length;a++){var n=e[a];n._action||(n._action={});var s="";n._action.isNew?s="info":n._action.delete?s="danger":n._action.modified&&(s="warning");var l=this.fieldTypeCaptions[n.type.toLowerCase()];t+=' <tr class="'+s+'" >',t+=" <td>"+n.name+"</td>",t+=' <td class="hidden-xs hidden-sm" >'+(n.alias?n.alias:"")+"</td>",t+=' <td class="hidden-xs hidden-sm">'+l+"</td>",t+=' <td class="hidden-xs ">'+(void 0!==n.length?n.length:"")+"</td>",t+=' <td class="hidden-xs ">'+(void 0!==n.default?n.default:"")+"</td>",n._action.delete?t+=' <td> <button type="button" class="btn btn-xs btn-info disabled\t" disabled onclick="javascript:"><span class="glyphicon glyphicon-edit"></span> Edit</button></td>':t+=' <td> <button type="button" class="btn btn-xs btn-info\t" onclick="javascript:pageTask.editField('+a+');"><span class="glyphicon glyphicon-edit"></span> Edit</button></td>',n._action.delete?t+=' <td><button type="button" class="btn btn-xs btn-danger\t" title="Undelete" style=" text-decoration: line-through;" class="btn-link  glyphicon glyphicon-remove" onclick="javascript:pageTask.deleteField('+a+');"><span class="glyphicon glyphicon-remove"></span> Undelete</button></td>':t+=' <td><button type="button" class="btn btn-xs btn-danger\t"  title="Delete"  style="" class="btn-link  glyphicon glyphicon-remove" onclick="javascript:pageTask.deleteField('+a+');"><span class="glyphicon glyphicon-remove"></span> Delete</button></td>',t+=" </tr>"}0<e.length&&(t+=" <tr>",t+=" <td></td>",t+=' <td class="hidden-xs hidden-sm"></td>',t+=' <td class="hidden-xs hidden-sm"></td>',t+=' <td class="hidden-xs "></td>',t+=' <td class="hidden-xs "></td>',t+=' <td> <button type="button" class="btn btn-xs btn-primary\t" onclick="javascript:pageTask.editField(-1);"><span class="glyphicon glyphicon-plus"></span> Add</button></td>',t+=" <td></td>",t+=" </tr>"),t+=" </tbody>",t+=" </table>",t+=" </div>",i.html(t)},deleteField:function(e){var i=this.fields,t=i[e];t._action||(t._action={}),t._action.isNew?0<=e&&e<i.length&&i.splice(e,1):t._action.delete?delete t._action.delete:t._action.delete=!0,this.fillFieldList()},editField:function(a){var i,t=this,n=this.fields,s=!1;if(a<0?i={_action:{isNew:s=!0}}:a<n.length&&(i=n[a]),i){i._action||(i._action={}),i._action.isNew||i._action.origField||(i._action.origField={name:i.name,alias:i.alias,type:i.type,length:i.length,default:i.default,notNull:i.notNull,isExpression:i.isExpression,expression:i.expression}),i._action.index=a;var e=$("#shapeType").val();new EditFieldDlg({field:i,shapeType:e,details:t.details,onValidate:function(e){for(var i=!1,t=0;t<n.length;t++)if(a!=t&&e.field.name.toLowerCase()==(n[t].name+"").toLowerCase()){i=!0;break}if(i)return e.valid=!1,void(e.message=e.field.name+" already exists!")},onSuccess:function(e){i._action.modified=!0,i.name=e.field.name,i.alias=e.field.alias,i.type=e.field.type,i.length=e.field.length,i.scale=e.field.scale,i.default=e.field.default,i.notNull=e.field.notNull,i.isExpression=e.field.isExpression,i.expression=e.field.expression,i._action.origField&&i.name===i._action.origField.name&&i.alias==i._action.origField.alias&&i.type===i._action.origField.type&&i.length==i._action.origField.length&&i.scale==i._action.origField.scale&&i.default==i._action.origField.default&&i.notNull==i._action.origField.notNull&&i.expression==i._action.origField.expression&&(i._action.modified=!1),s&&(i.expression&&(i.isExpression=!0),n.push(i)),t.fillFieldList()}}).show()}},submit:function(){var l=this;$.validator.unobtrusive.parse(document);var e=$("#mainForm");e.validate();var i=$("#frmDetail");i.validate();var t=i.valid(),a=e.valid();if(t&&a){waitingDialog.show("Saving Datalayer",{progressType:""});var o=this.details.datasetName;this.details.isNew&&(this.details.shapeType=$("#shapeType").val()),o||(o=""),e.find("#details").val(JSON.stringify(this.details)),$.ajax({type:e.attr("method"),url:e.attr("action"),data:e.serialize(),success:function(e){e.id;waitingDialog.hide();location.protocol,location.host,location.pathname;var i="/datalayer/"+e.id;if(i!=location.pathname){var t=location.protocol+"//"+location.host+i;window.history.replaceState({},document.title,t)}if(e.status){if($.notify({message:"Data Layer saved successfully"},{type:"success",delay:2e3,animate:{enter:"animated fadeInDown",exit:"animated fadeOutUp"}}),e.item&&e.item.details)try{l.fillUI(JSON.parse(e.item.details))}catch(e){}var a="/datalayer/"+e.id+"/geojson"+"?settings="+encodeURIComponent(JSON.stringify({filter:{},validate:!0})),n=$.notify({message:'<i class="wait-icon-with-padding">Validating ...</i><br />'},{type:"info",delay:0,z_index:5e4,animate:{enter:"animated fadeInDown",exit:"animated fadeOutUp"}});$.ajax(a,{type:"GET",dataType:"json",success:function(e){e&&(e.status?($.notify({message:e.rowCount+" row(s) are returned successfully."},{type:"success",delay:3e3,z_index:5e4,animate:{enter:"animated fadeInDown",exit:"animated fadeOutUp"}}),setTimeout(function(){window.location.href=location.protocol+"//"+location.host+"/datalayers"},2e3)):$.notify({message:"Validation failed <br />Error:"+e.message+"<br/> Check fields' expressions"},{type:"danger",delay:5e3,z_index:5e4,animate:{enter:"animated fadeInDown",exit:"animated fadeOutUp"}})),n.close()},error:function(e,i,t){$.notify({message:t+"<br/>Failed to complete task"},{type:"danger",delay:3e3,z_index:5e4,animate:{enter:"animated fadeInDown",exit:"animated fadeOutUp"}}),n.close()}}).done(function(e){n.close()})}else{var s=e.errors||e.error||e.message||"Failed to save Data Layer";s=(s+="").replace(new RegExp(o,"g"),""),$.notify({message:s},{type:"danger",delay:1e4,animate:{enter:"animated fadeInDown",exit:"animated fadeOutUp"}})}},error:function(e,i,t){waitingDialog.hide(),console.log("An error occurred."),$.notify({message:"Failed to save Data Layer"},{type:"danger",delay:2e3,animate:{enter:"animated fadeInDown",exit:"animated fadeOutUp"}})}})}else{var n=$(".input-validation-error").first();n&&$("html, body").animate({scrollTop:n.offset().top-20},1e3)}}};function EditFieldDlg(e){var t=this;this.fieldTypeTips={varchar:"variable-length character string, up to defined Length",boolean:"Boolean values like;true|false,yes|no,1|0",smallint:"2 bytes small integer, range:\t-32768 to +32767",integer:"4 bytes typical choice for integer, range: -2147483648 to +2147483647",bigint:"8 bytes large integer, rage: -9223372036854775808 to +9223372036854775807",numeric:"variable\tnumber with user-specified precision. <br /> Example, A numeric field with Length=5 and Scale=2 can store -999.99 to 999.99 ",real:"4 bytes\tvariable-precision, inexact\t6 decimal digits precision","double precision":"8 bytes\tvariable-precision, inexact\t15 decimal digits precision",date:"4 bytes date (no time of day)","timestamp with time zone":'8 bytes\tboth date and time with time zone, example:2018-08-28 12:22:01.673<span class="label label-info">+04:30</span>',bytea:"BLOB, Binary Large OBject"},this.options=e||{},this.field=this.options.field,this.parent_shapeType=this.options.shapeType,this.parent_details=this.options.details||{},void 0===this.field.type&&(this.field.type="varchar",this.field.length=20),this.onSuccess=this.options.onSuccess,this.onValidate=this.options.onValidate,this.body=$("#fieldDlgTemplate").clone(),this.dlg=new BootstrapDialog({title:"Field properties",message:function(e){var i=t.body;t.initFrom();i.find("#type").change(function(){t.updateUI()});return t.updateUI(),i},draggable:!0,closable:!0,closeByBackdrop:!0,closeByKeyboard:!0,buttons:[{label:"OK",cssClass:"btn-primary",action:function(e){t.apply()&&(t.changesApplied=!0,e.close())}},{label:"Cancel",action:function(e){e.close()}}],onshow:function(e){},onshown:function(e){},onhide:function(e){},onhidden:function(e){t.changesApplied||t.cancelSettings()}})}EditFieldDlg.prototype.initFrom=function(){var e=this,i=this.body;if(e.field){i.find("#name").val(void 0===e.field.name?"":e.field.name),i.find("#alias").val(void 0===e.field.alias?"":e.field.alias);var t=i.find("#type");t.val(void 0===e.field.type?"varchar":e.field.type);var a,n=t.val();i.find("#typeTip").html(e.fieldTypeTips[n]),i.find("#length").val(void 0===e.field.length?"":e.field.length),i.find("#scale").val(void 0===e.field.scale?"":e.field.scale),i.find("#default").val(e.field.default),e.parent_details&&e.parent_details.spatialReference&&(a=e.parent_details.spatialReference.srid);var s="";"MultiPolygon"!=e.parent_shapeType&&"Polygon"!=e.parent_shapeType||(4326==a?(s+='<option value="ST_Area(geom::geography)" > Area</option>',s+='<option value="ST_Perimeter(geom::geography)" > Perimeter</option>'):(s+='<option value="ST_Area(geom)" > Area</option>',s+='<option value="ST_Perimeter(geom)" > Perimeter</option>'),s+='<option value="ST_X(ST_Centroid(geom))" > Centroid.X</option>',s+='<option value="ST_Y(ST_Centroid(geom))" > Centroid.Y</option>'),"MultiLineString"!=e.parent_shapeType&&"LineString"!=e.parent_shapeType||(s+=4326==a?'<option value="ST_Length(geom::geography)" > Length</option>':'<option value="ST_Length(geom)" > Length</option>',s+='<option value="ST_X(ST_Centroid(geom))" > Centroid.X</option>',s+='<option value="ST_Y(ST_Centroid(geom))" > Centroid.Y</option>'),"Point"==e.parent_shapeType&&(s+='<option value="ST_X(geom)" > X</option>',s+='<option value="ST_Y(geom)" > Y</option>'),i.find("#expression").append(s),i.find("#expression").val(e.field.expression),i.find("#expression").change(function(){i.find("#type").val("real")})}},EditFieldDlg.prototype.updateUI=function(){var e=this.body,i=e.find("#type").val();e.find("#typeTip").html(this.fieldTypeTips[i]);var t=!1;this.field&&this.field._action&&this.field._action.isNew&&(t=!0),"varchar"==i||"numeric"==i?e.find(".form-group").has("#length").show():e.find(".form-group").has("#length").hide(),"numeric"==i?e.find(".form-group").has("#scale").show():e.find(".form-group").has("#scale").hide(),this.field&&this.field.isExpression?(e.find(".form-group").has("#expression").show(),e.find(".form-group").has("#default").hide(),e.find(".form-group").has("#type").hide(),e.find(".form-group").has("#typeTip").hide(),e.find(".form-group").has("#length").hide()):(t?e.find(".form-group").has("#expression").show():e.find(".form-group").has("#expression").hide(),e.find(".form-group").has("#default").show(),e.find(".form-group").has("#type").show(),e.find(".form-group").has("#typeTip").show(),e.find(".form-group").has("#length").show())},EditFieldDlg.prototype.create=function(){this.changesApplied=!1},EditFieldDlg.prototype.apply=function(){$.validator.unobtrusive.parse(document),this.body.find("#errors").hide();var e=this.body.find("#frmField");if(e.validate(),!e.valid())return!1;var i=e.find("#type").val(),t=e.find("#scale").val();try{t=parseInt(t),isNaN(t)&&(t=void 0)}catch(e){}var a=e.find("#length").val();try{a=parseInt(a),isNaN(a)&&(a=void 0)}catch(e){}var n={name:e.find("#name").val(),type:i,notNull:this.field.notNull,isExpression:this.field.isExpression};if(e.find("#alias").val()&&(n.alias=e.find("#alias").val()),a&&(n.length=a),t&&(n.scale=t),e.find("#default").val()&&(n.default=e.find("#default").val()),"varchar"!=i&&"numeric"!=i&&(n.length=""),n.expression=e.find("#expression").val(),this.onValidate){var s={valid:!0,message:"",field:n};if(this.onValidate(s),!s.valid)return this.body.find("#errors").html("<div>"+s.message+"</div>").show(),!1}return this.onSuccess&&this.onSuccess({field:n}),!0},EditFieldDlg.prototype.cancelSettings=function(){return!0},EditFieldDlg.prototype.show=function(){this.create(),this.dlg.open()};